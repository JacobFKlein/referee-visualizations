---
title: "Examination of Referee Tendencies and Biases in the National Football League"
author: "Thompson Bliss, Connor Daly, Jacob Klein, Patrick Lewis"
affiliation: "Columbia University: Data Science Institute"
date: "December 2018"
output:
  html_document:
    toc: false
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE,
                      echo = FALSE)
```

<style>
p.caption {
  font-size: 1em;
  font-family: 'Big Caslon';
}
</style>

<style>
  body {
  text-align: justify}
</style>

Next weekend, millions of people around the world will tune in to watch Super Bowl LIII. Following what many are considering to be two of the most controversial playoff games in the history of the NFL, this year's event features the Los Angeles Rams and the New England Patriots. Both of these teams managed to advance to the prestigious game with some thanks to favorable penalties (or lack thereof) called by the referee crews officiating their respective games.

Throughout recent years, an increasing amount of attention has been placed on penalty calls in the NFL. Penalties can dramatically alter the flow and outcomes of games (as was arguably the case in both the AFC and NFC Championship games last weekend), so ensuring that penalties are called fairly and consistently is crucial to maintaining the integrity of the game.

The frequency, consistency, and possible biases of penalty calls in the NFL are areas of football analytics that have only garnered minimal attention individually, let alone all together, which served as the primary source of motivation for this analysis. We examine penalty distributions in a variety of ways, and we frequently refer to NFL officials by name. To avoid any confusion or misinterpretations, it is important to note that these names represent the head referees of NFL crews, rather than by the individual referee who called the penalty. Every NFL game is watched by a group of seven officials, which includes one referee, one umpire, and five line judges. Although NFL officials are labeled by name in the following analyses and visualizations.

Data for this analysis was collected from the beginning of the 2013-2014 NFL season through week 9 of the 2018-2019 NFL season.

##Penalty Types

Weekly viewers of NFL football are sometimes confused about why certain types of penalties occur more frequently in one week versus another. This inconsistency certainly could be a function of luck combined with sloppiness by the players, but it also could have to do with biases by referee crews towards calling or not calling certain penalty types. For example, some referee crews may throw the flag for any action nearing an illegal tackle while others may be compelled to let questionable actions slide and go uncalled. To examine the distribution of penalty types, the following bar chart can be constructed:

```{r}

#Defining Global Libraries and Actions

library(dplyr)
library(ggplot2)
library(scales)
library(gdata)
library(tidyr)
library(kfigr)
library(ggrepel)

refData = read.csv('./data/df_ref.csv')

theme_ref = theme(axis.title.x = element_text(size = 16),axis.title.y = element_text(size = 16), plot.title = element_text(hjust = 0.5, size = 18), panel.background = element_rect(fill = "white", colour = "white", size = 0.5, linetype = "solid"),  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "gray90"), panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "gray90"))


```

```{r anchor='Figure', fig.height = 6, fig.cap="Figure 1: Average Number of Each Penalty Type Called Per Game", fig.align= 'center'}

#Putting Together Data


df_ref <- refData

#Calculating Average ref data
totalNumberOfGames = nlevels(as.factor(paste(df_ref$GameDate, df_ref$Home)))

#Calculating number of games each ref worked
totalNumberOfGamesByRef <- unique(df_ref[c("Referee", "GameDate")]) %>% group_by(Referee) %>% summarize(numReffed = n())


#Adding the total game numbers to the df_ref
df_ref = merge(df_ref, totalNumberOfGamesByRef, by = "Referee")


#Getting average penalty types called for all refs
averagePenaltyTypeCalled = table(df_ref$PenaltyType) / totalNumberOfGames
df_averagePenaltyTypeCalled = as.data.frame(averagePenaltyTypeCalled)
colnames(df_averagePenaltyTypeCalled) = c("PenaltyType", "FreqTotal")


#Getting Average called by refs
PenTypeCounts <- df_ref %>% group_by(Referee, PenaltyType) %>% 
    summarize(Freq = n() / numReffed[1])

#Removing NA/Other Categories
PenTypeCounts <- PenTypeCounts[!is.na(PenTypeCounts$Referee),]
PenTypeCounts <- PenTypeCounts[PenTypeCounts$PenaltyType != "OTHER",]


#Changing Data sorted by ref to diversion from average of all refs
for (penType in levels(df_ref$PenaltyType)){
  PenTypeCounts[PenTypeCounts$PenaltyType == penType,]$Freq = 
 1  - PenTypeCounts[PenTypeCounts$PenaltyType == penType,]$Freq/as.double(averagePenaltyTypeCalled[penType])
  
}

PenTypeCounts <- merge(PenTypeCounts, df_averagePenaltyTypeCalled, by = "PenaltyType")

ggplot(df_averagePenaltyTypeCalled, aes(x = reorder(PenaltyType, - FreqTotal), y = FreqTotal)) + geom_bar(stat = "identity", color = "black", fill = "red", alpha = 0.6) + theme(plot.title = element_text(hjust = 0.5), axis.text.x  = element_text(angle=45, hjust = 1)) + xlab("Penalty Type") + ylab("Average Number Called Per Game") + ggtitle("Average Number of Each Penalty Type Called Per Game") + theme_ref


```

Figure 1 shows how the average referee crew will make penalty calls in a game. `Offside` and `Illegal Block` are the most common penalties. This commonality is not suprising as running across the line of scrimmage and blocking are two fundamental aspects of the game and thus are bound to be done incorrectly sometimes. Moreover, it is also not suprising that particularly sloppy penalties such as `Too Many Men on the Field`, `Illegal Formation`, and `Delay of Game` are rare. Moreover, not every referee crew calls penalties at the exact rates as highlighted in Figure 1. Figure 2 below shows the percentages of increases or decreases from these averages by referee crew.


```{r penaltyTypeIncrease, anchor='Figure', fig.width = 8, fig.height = 17, fig.cap="Figure 2: Percentage of Increase/Decrease from Average Penalty Type", fig.align= 'center'}
#Setting Color Scheme
PenTypeCounts$FreqType = PenTypeCounts$Freq < 0

#Plotting Data Faceted by Ref
ggplot(PenTypeCounts, aes(x=reorder(PenaltyType, FreqTotal), y=Freq, fill=FreqType))+
  geom_bar(stat="identity",position="identity")+ ggtitle("Percentage of Increase/Decrease from Average Penalty Type Called") + scale_fill_manual(values = c("green","red"), guide = FALSE)+ facet_wrap(~Referee, nrow = 9, ncol = 2, scales = 'free_x') + coord_flip() + geom_hline(yintercept=0) + theme(panel.spacing = unit(1, "lines")) +xlab('') + ylab('Percentage of Divergence from Average')  + scale_y_continuous(labels = percent, limits=c(-0.6,0.6)) + theme_ref

keep(refData, theme_ref, sure = TRUE)


```

The above graph provides insight regarding tendencies of NFL referee crews to call or not call certain types of penalties. For example, the crew of Bill Vinovich seems to call more penalties than average regardless of penalty type. Additionally, Walt Anderson's crew seems to call less penalties than average regardless of type.


##Analysis by Home/Away Team

It is common to think that teams are often called for more penalties when they are playing on the road as opposed to playing in their home cities. This difference can be a function of player familiarity with the field, miscommunication between members of the away team due to loudness of the home crowd, and/or referee crew reaction to crowd noise encouraging or discouraging certain calls. The percentages of calls against home teams and away teams by penalty type are shown in Figure 3 below.

```{r, anchor='Figure', fig.cap="Figure 3: Percentages of Penalties Called Against the Home/Away Teams by Penalty Type", fig.align= 'center', fig.width = 8}

#Reading in data
df_ref <- refData

#Calculating penalties against away team
df_ref$AgainstAway = df_ref$PenaltyTeam == df_ref$Away

#Removing rows with NA values for against away
df_ref = df_ref[!is.na(df_ref$AgainstAway),]

#making tables by penalty type
tableAgainstAway = table(df_ref[df_ref$AgainstAway,]$PenaltyType)
tableAgainstHome = table(df_ref[!df_ref$AgainstAway,]$PenaltyType)

#getting df of percentage of away vs home
df_percentage = as.data.frame(tableAgainstAway / (tableAgainstAway + tableAgainstHome))
df_percentage$against = "Away"
df_percentage2 = as.data.frame(tableAgainstHome / (tableAgainstAway + tableAgainstHome))
df_percentage2$against = "Home"
df_percentage = rbind(df_percentage, df_percentage2)

df_percentage$plotOrder = df_percentage[df_percentage$against == "Away",]$Freq

#plot
ggplot(df_percentage, aes(x = reorder(Var1, - plotOrder), y = Freq, color = against)) + geom_hline(yintercept=0.5) + geom_point(stat = "identity", size = 3) + xlab("Referee Name") + ggtitle("% of Penalties Called Against the Home/Away Teams by Penalty Type") + ylab("Percentage of Penalties Against") + scale_y_continuous(labels = percent, limits=c(0.4,0.6)) + labs(color = "Perentage Called Against") +coord_flip() + theme_ref

```

In Figure 3, we see that a timing penalty (i.e. `Delay of Game`) is the most unfavorable towards the away team, which can likely be attributed to home crowds often increasing their noise levels in attempts to cause such penalties on the away teams. However, the higher degree of `Illegal Tackle` penalties that we observe is decently suprising. An illegal tackle penalty is not based on familiarity with field or pre-snap timing which suggests that it may be a function of referee crew responses to crowd noise. Moreover, the percentages of penalties called against home teams and away teams by referee crew is shown in Figure 4 below.

```{r ref_home_away_1, anchor='Figure', fig.cap="Figure 4: Percentages of Penalties Called Against Home and Away Teams by Referee", fig.align= 'center', fig.height= 7, fig.width = 7.75}

rm(df_percentage)
rm(df_percentage2)

#making tables by referee
tableAgainstAway = table(df_ref[df_ref$AgainstAway,]$Referee)
tableAgainstHome = table(df_ref[!df_ref$AgainstAway,]$Referee)

#getting df of percentage of away vs home
df_percentage = as.data.frame(tableAgainstAway / (tableAgainstAway + tableAgainstHome))
df_percentage$against = "Away"
df_percentage2 = as.data.frame(tableAgainstHome / (tableAgainstAway + tableAgainstHome))
df_percentage2$against = "Home"
df_percentage = rbind(df_percentage, df_percentage2)

df_percentage$Var1 = as.character(df_percentage$Var1)

#Adding average data to chart
df_percentage = rbind(df_percentage, c("AVERAGE", sum(df_ref$AgainstAway) / length(df_ref[,1]), "Away" ))

df_percentage = rbind(df_percentage, c("AVERAGE", 1 - sum(df_ref$AgainstAway) / length(df_ref[,1]), "Home"))


#Resetting column types
df_percentage$Var1 = as.factor(df_percentage$Var1)
df_percentage$Freq = as.double(df_percentage$Freq)
df_percentage$against = as.factor(df_percentage$against)


#creating order for plot
df_percentage = df_percentage[order(df_percentage$against),]
df_percentage$plotOrder = df_percentage[df_percentage$against == "Away",]$Freq

df_percentage$avg = FALSE
df_percentage[df_percentage$Var1 == "AVERAGE",]$avg = TRUE

#plot
ggplot(df_percentage, aes(x = reorder(Var1, -plotOrder), y = Freq, color = against)) + geom_hline(yintercept=0.5)  + geom_point(stat = "identity", size = 3, aes(shape = avg)) + xlab("Penalty Type") + ylab("Percentage of Penalties Against") + ggtitle("% of Penalties Called Against Home/Away Teams by Referee") + scale_y_continuous(labels = percent, limits=c(0.4,0.6)) + labs(color = "Percentage Called Against") +coord_flip() + guides(shape = FALSE) + theme_ref

keep(refData, theme_ref, sure = TRUE)
```

Here we see that nearly every referee crew calls more penalties against the away teams than the home teams. The crew led by John Hussey is the only exception and is just below the 50% mark, while Pete Morelli's crew has the highest percentage of penalty calls against away teams at nearly 55%. As a whole, all of the referee crews call home and away penalties at rates around 50%, which suggests that penalty calling is quite fair even though we would expect a slight trend toward more penalties called against away teams because of the aforementioned points.

##Analysis by Quarter

We continue our exploratory data analysis by examining the distribution of penalties per game by quarter. Figure 5 shows this distribution at an aggregate level:
```{r penalties_by_q, anchor='Figure', fig.cap="Figure 5: Penalties Per Game by Quarter", fig.align= 'center'}
df2 <- refData

df_by_q <- df2[c(1,27,28,2)]
df_by_q <- df_by_q %>%
  mutate(gameID = paste(GameDate, Home, Away))
reg_len <- n_distinct(df_by_q$gameID)
ot <- df_by_q %>%
  filter(Quarter == 5)
ot_len <- n_distinct(ot$gameID)
df_by_q <- df_by_q %>%
  group_by(Quarter) %>%
  summarise(count = n()) %>%
  mutate(adj_count = ifelse(Quarter < 5, count/reg_len, count/ot_len))
df_by_q$Quarter <- as.factor(df_by_q$Quarter)
levels(df_by_q$Quarter) <- c("Q1", "Q2", "Q3", "Q4", "Overtime")


ggplot(df_by_q, aes(x = Quarter, y = adj_count, width = 0.8)) +
  geom_bar(stat = "identity", color = "black", fill = "red", alpha = 0.6) +
  ggtitle("Penalties Per Game by Quarter") +
  xlab("Quarter") +
  ylab("Count Per Game") +
  theme_ref

```

As seen here, most penalties are called in quarters two and four of games. A high frequency of penalties in quarter four is not too surprising, because the game is nearing conclusion at this point and we expect that teams have higher risk tolerances as they attempt to end the games as victors. On the other hand, the fact that quarter two has the highest penalty frequency is somewhat surprising because one would intuitively think that the game progresses fluidly at this point, having already played a full quarter and thus teams have gotten over any jitters or states of hesitancy. It is also surprising that quarter one yields the lowest penalty frequency, but we can pose a couple different hypotheses for this pattern: perhaps pace of play is slower in the first quarter than in the other three, or perhaps there is some inherent bias in referees not wanting to begin games by immediately calling penalties.

Also included in this graph is the penalty frequency for overtime periods. Although it appears that penalties are called less frequently in overtime than in normal quarters, it is important to note that overtime generally does not last the full length of a regular quarter. Thus, the frequency of penalties called in overtime seems proportional to that of quarters one through four when we account for duration of play.

##Interactive - Offensive/Defensive Penalties by Area of Field

This component serves to act as an interactive application that users can use to learn about how penalities within the NFL occur at different frequencies depending on field position.

To get started place your mouse on a 10 yard zone of the field. One can also use the toggle below to filter by offensive/defensive penalties.

```{r}
htmltools::includeHTML("./docs/index_report.html")
```

##Conclusion

Although many technological advances are constantly being made in just about all sports (such as the introduction of instant replay), referees are an inherently human part of football. Thus, at the core of the exploratory data analysis conducted in this project lies human behavior. No two humans see things the exact same way, which serves as some justification for the inconsistencies we see in referee penalty calls, despite much effort taken by the NFL to define the constitution of particular penalties in objective terms. Therefore, we must err on the side of caution when identifying anomalies or inconsistencies in our dataset.

If interested in exploring the dataset, code, or analysis in more detail, you can find all work located [here](https://github.com/JacobK-/referee-visualizations).