---
title: "Penalties_byTeam_byReferee"
output:
  html_document: default
  pdf_document: default
latex_engine: xelatex
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cluster)
library(ggplot2)
library(dplyr)
library(lubridate)
library(stringr)
library(plotly)
#install.packages('ggridges')
library(ggridges)
#install.packages("viridis")
library(viridis)
setwd(getwd())

dataFile<-'./data/df_ref.csv'

refData<-read_csv(dataFile)
#summarize(refData)
```



```{r}
#NOW WE LOOK BY REFEREE BY TEAM

penRef<-refData %>%
  group_by(Referee,PenaltyTeam) %>%
  summarize(n=n())

#penRef

penaltiesPerGame<-refData %>%
  group_by(GameDate,PenaltyTeam) %>%
  summarize(n=n())


colnames(penRef)<-c("Referee","PenaltyTeam","NPenalties")


#So we have the number of penalties by ref...now we just need the number of games each ref did for each team
#The best way that we can do this is through using two DPYLR statements, one to get unique games by team, then
#to summarize by ref by team

refDataTemp<-refData
NoGamesRef<- refDataTemp %>%
  filter(!is.na(PenaltyTeam)) %>% 
  group_by(Referee,PenaltyTeam,GameDate) %>%
  summarize(Unique_Elements = n_distinct(GameDate))

NoGamesRef <- NoGamesRef%>%
  group_by(Referee,PenaltyTeam) %>%
  summarize(n=n())

colnames(NoGamesRef)<-c("Referee","PenaltyTeam","NGames")

penRef<-merge(x=penRef,y=NoGamesRef)
penRef$PenPerGame <- penRef$NPenalties/penRef$NGames


temP<-penRef%>%
  group_by(PenaltyTeam)%>%
  dplyr::summarize(Median = median(PenPerGame))

#temP
penRef<-merge(x=penRef,y=temP)

penRef<-penRef[complete.cases(penRef),]

ggplot(penRef, aes(x=reorder(Referee,PenPerGame),y=PenPerGame))+geom_point()+coord_flip()+ggtitle("Average Number of Penalties By Team, by Referee")+xlab('Ref Name')+ylab('Average No. Penalties by Team')+theme_bw()+geom_hline(yintercept=(mean(penRef$PenPerGame)),color='Red',alpha=0.4)





```
The above is data prep.

```{r}
fill <- "#4271AE"
line <- "#1F3552"

boxPlotTeam<-ggplot(penRef, aes(x=reorder(PenaltyTeam,Median),y=PenPerGame))+geom_boxplot(fill=fill,colour=line,outlier.colour = "red4", outlier.alpha=1,outlier.shape = 18,alpha=0.5)+coord_flip()+ggtitle("Number of Penalties Given by Referee By Team")+xlab('Team')+ylab('Average Number of Penalties given By Referee')+theme_light()
boxPlotTeam


#interactiveBoxTeam<-ggplotly(boxPlotTeam)
#interactiveBoxTeam
```
In the chart above, we are looking at the distribution of the average number of penalties per Referee. IE, for each team there will be 16 data points as we are looking at 16 referees. Each of the referees will have an average penalties per game for each time, which is what we are charting above. Note that in the absolute majority of cases, referee's call a similar number of penalties; however there are a few cases where referees call many more or many less penalties against a team. Note that some teams have a huge variance of penalties called against, such as Buffalo while others, such as the New York Giants, have a very small variance in the average number of penalties called. Regardless, what we are truly interested in within this chart are the outliers. Having referees make calls that are expected is not something that we are looking for, and as such a closer look at the outliers is below.



```{r}
is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}

#penRef %>%
#  group_by(PenaltyTeam) %>%
#  mutate(outlier = ifelse(is_outlier(PenPerGame), Referee,NA)) %>%
#  ggplot(., aes(x = factor(PenaltyTeam), y = PenPerGame)) +
#    geom_boxplot() +
#    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3)


```



```{r fig.width=9}
#Buffalo (BUF), Oakland (OAK), Detroit (DET), NYG seem like interesting ones
#SEA,KC, ATL,ARI,NE

BUFPenRef<-penRef[penRef[,1]=='BUF',]
OAKPenRef<-penRef[penRef[,1]=='OAK',]
NYGPenRef<-penRef[penRef[,1]=='NYG',]
DETPenRef<-penRef[penRef[,1]=='DET',]
NEPenRef<-penRef[penRef[,1]=='NE',]
KCPenRef<-penRef[penRef[,1]=='KC',]
ATLPenRef<-penRef[penRef[,1]=='ATL',]
ARIPenRef<-penRef[penRef[,1]=='ARI',]
SEAPenRef<-penRef[penRef[,1]=='SEA',]

subsetTeams <- rbind(KCPenRef,OAKPenRef)
subsetTeams <- rbind(subsetTeams,NYGPenRef)
subsetTeams <- rbind(subsetTeams,DETPenRef)
subsetTeams <- rbind(subsetTeams,NEPenRef)
subsetTeams <- rbind(subsetTeams,ARIPenRef)
subsetTeams <- rbind(subsetTeams,SEAPenRef)
subsetTeams <- rbind(subsetTeams,ATLPenRef)

ggplot(SEAPenRef,aes(x=PenPerGame))+geom_histogram(binwidth =1)+theme_light()+ylab('Count')+xlab('Penalties Per Game')+ggtitle('Seattle: Average Penalties Called Per Game')

fill <- "#4271AE"
line <- "#1F3552"

subsetTeams

subsetTeams %>%
  group_by(PenaltyTeam) %>%
  mutate(outlier = ifelse(is_outlier(PenPerGame), Referee,NA)) %>%
  ggplot(., aes(x = factor(PenaltyTeam), y = PenPerGame)) +
    geom_boxplot(fill=fill,colour=line,alpha = 0.5,outlier.colour = "red4", outlier.alpha=1,outlier.shape = 18,outlier.size = 1.5) +
    geom_text(aes(label = outlier), na.rm = TRUE,hjust = 1.1,size=4)+
    theme_light()+xlab('Team')+ylab('Average Penalty per Game by Referee')+ggtitle('Average Number of Penalties by Referee, by Team')

```
To recap what this chart is showing, we essentially took the previous chart and removed the teams that did not have outliers. In this way, we are focusing on the points that we really care about. Note the recurring Referees. We see Terry McAulay’s crew appears to call significantly more penalties against Detroit and Oakland than the other referees. Jerome Boger’s crew also calls significantly more calls against Kansas City and Seattle than other crews. Note the deviation in some of these cases. Perhaps more interestingly, we also see John Hussey’s crew calls much fewer penalties against New England, while calling significantly more penalties against the New York Giants.


```{r fig.height=13}
#Some Ridgeline Plots and Violin plots in case they are useful...but probably dont want to include all of them

ggplot(subsetTeams, aes(x = reorder(PenaltyTeam, PenPerGame),y = PenPerGame)) +geom_violin() + 
    ggtitle("Penalty per Game") +
    coord_flip() + theme_light(14)


#ggplot(subsetTeams, aes(x = PenPerGame,y = reorder(PenaltyTeam, Median))) +geom_density_ridges(fill='blue',alpha= 0.4,scale=2,rel_min_height=0.01) + xlab("Penalty per Game by Referee") + theme_light()+ylab('Team')+ggtitle('Average # of Penalties called by Referees')

Temp1<-penaltiesPerGame%>%
  group_by(PenaltyTeam)%>%
  dplyr::summarize(Median = median(n))

penaltiesPerGame<-merge(x=penaltiesPerGame,y=Temp1)
#penaltiesPerGame

ggplot(penaltiesPerGame, aes(x = n,y =reorder(PenaltyTeam,Median))) +geom_density_ridges(fill = 'blue',alpha = 0.4,scale=1.5,rel_min_height=0.01) + 
    ggtitle("Penalty per Game") + theme_light()+xlim(0,25)

#ggplot(penRef, aes(x = PenPerGame,y = reorder(Referee, Median))) +geom_density_ridges(fill = 'blue',alpha = 0.3,scale=2,rel_min_height=0.01) + 
#    ggtitle("Distribution of Average # Of Penalties by Team") + theme_light()+ylab('Referee')+xlab('Distribution of Average Number of Penalties per Game by Team')



```




```{r}






```